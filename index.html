<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X-TRAGO Live GPS Map</title>

  <!-- MQTT Client -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Leaflet Map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: radial-gradient(circle at center, #001f5c, #00081a);
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 20, 60, 0.85);
      color: #00ffff;
      padding: 10px 15px;
      border-radius: 12px;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.4);
      backdrop-filter: blur(6px);
      transition: all 0.3s ease;
    }

    #info b {
      color: #7df9ff;
    }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="info">üõ∞ Inisialisasi lokasi awal...</div>

  <script>
    // ===========================
    // Konfigurasi MQTT HiveMQ
    // ===========================
    const brokerURL = "wss://f89f938116df4dee81d5215df5ba4782.s1.eu.hivemq.cloud:8884/mqtt";
    const options = {
      username: "intelligent",
      password: "Penem2018",
      protocol: "wss",
      port: 8884,
      reconnectPeriod: 2000,
      connectTimeout: 4000
    };

    // ===========================
    // Lokasi default (idle)
    // ===========================
    const idleLat = -7.6476625;
    const idleLon = 111.5219402;
    const idleZoom = 16;

    // Ambil lokasi terakhir dari localStorage (jika ada)
    let savedLocation = JSON.parse(localStorage.getItem("lastLocation")) || {
      lat: idleLat,
      lon: idleLon,
      zoom: idleZoom
    };

    // ===========================
    // Inisialisasi Peta
    // ===========================
    let map = L.map("map").setView([savedLocation.lat, savedLocation.lon], savedLocation.zoom);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
    }).addTo(map);

    let marker = L.marker([savedLocation.lat, savedLocation.lon]).addTo(map);
    let infoBox = document.getElementById("info");

    // ===========================
    // Koneksi ke MQTT Broker
    // ===========================
    const client = mqtt.connect(brokerURL, options);

    client.on("connect", () => {
      console.log("‚úÖ Terhubung ke HiveMQ Cloud");
      infoBox.innerHTML = "‚úÖ MQTT Connected<br>Menunggu data GPS...";
      client.subscribe("maps");
    });

    client.on("error", (err) => {
      console.error("‚ùå MQTT Error:", err);
      infoBox.innerHTML = "‚ùå MQTT Error<br>" + err.message;
    });

    client.on("reconnect", () => {
      infoBox.innerHTML = "üîÑ Reconnecting MQTT...";
    });

    // ===========================
    // Update Lokasi dari MQTT
    // ===========================
    client.on("message", (topic, message) => {
      const payload = message.toString().trim();
      console.log("üì© Data diterima:", payload);

      // Cegah update jika payload kosong, null, atau tidak mengandung q=
      if (!payload || payload === "null" || !payload.includes("q=")) {
        console.warn("‚ö† Payload kosong atau tidak valid, abaikan.");
        return;
      }

      // Format payload: https://maps.google.com/?q=-7.62551,111.52790
      const match = payload.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
      if (!match) {
        console.warn("‚ö† Payload tidak sesuai format:", payload);
        return;
      }

      const lat = parseFloat(match[1]);
      const lon = parseFloat(match[2]);

      // Jika lokasi 0,0 ‚Üí abaikan (data tidak valid)
      if (lat === 0 && lon === 0) {
        console.warn("‚ö† Koordinat (0,0) diabaikan.");
        return;
      }

      // Simpan ke localStorage hanya jika data valid
      localStorage.setItem("lastLocation", JSON.stringify({ lat, lon, zoom: 17 }));

      // Update marker dan map
      marker.setLatLng([lat, lon]);
      map.flyTo([lat, lon], 17, { animate: true, duration: 1.5 });

      // Update info
      infoBox.innerHTML = `
        üì° <b>Live GPS</b><br>
        Lat: <b>${lat.toFixed(6)}</b><br>
        Lon: <b>${lon.toFixed(6)}</b><br>
        <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank" style="color:#7df9ff;">üåç Lihat di Google Maps</a><br>
        <small>üïí ${new Date().toLocaleTimeString()}</small>
      `;
    });

    // ===========================
    // Saat tidak ada data MQTT, tampilkan lokasi terakhir
    // ===========================
    window.addEventListener("load", () => {
      const { lat, lon } = savedLocation;
      infoBox.innerHTML = `
        üì° <b>Last Known GPS</b><br>
        Lat: <b>${lat.toFixed(6)}</b><br>
        Lon: <b>${lon.toFixed(6)}</b><br>
        <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank" style="color:#7df9ff;">üåç Lihat di Google Maps</a><br>
        <small>üïí ${new Date().toLocaleTimeString()}</small>
      `;
    });
  </script>
</body>
</html>
