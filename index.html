<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X-TRAGO Live GPS Map</title>

  <!-- MQTT Client -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Leaflet Map (OpenStreetMap) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      margin: 0;
      box-shadow: 0 0 20px rgba(0, 180, 255, 0.4);
      border-radius: 12px;
      padding: 0;
      outline: none;
      height: 100%;
      background: #001a3f;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 20, 40, 0.8);
      color: #00ffff;
      padding: 10px 15px;
      border-radius: 10px;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,255,255,0.5);
    }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="info">üõ∞ Menunggu data GPS...</div>

  <script>
    // ======================================
    // KONFIGURASI MQTT HIVEMQ CLOUD
    // ======================================
    const brokerURL = "wss://f89f938116df4dee81d5215df5ba4782.s1.eu.hivemq.cloud:8884/mqtt";
    const options = {
      username: "intelligent",
      password: "Penem2018",
      protocol: "wss",
      port: 8884,
      reconnectPeriod: 2000,
      connectTimeout: 4000
    };

    // ======================================
    // INISIALISASI PETA LEAFLET (OPENSTREETMAP)
    // ======================================
    let map = L.map("map").setView([-7.6256, 111.528], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
    }).addTo(map);

    let marker = L.marker([-7.6256, 111.528]).addTo(map);
    let infoBox = document.getElementById("info");

    // ======================================
    // KONEKSI MQTT
    // ======================================
    const client = mqtt.connect(brokerURL, options);

    client.on("connect", () => {
      console.log("‚úÖ Terhubung ke HiveMQ Cloud");
      infoBox.innerHTML = "‚úÖ MQTT Connected<br>Menunggu data GPS...";
      client.subscribe("maps"); // sesuai program ESP32
    });

    client.on("error", (err) => {
      console.error("‚ùå MQTT Error:", err);
      infoBox.innerHTML = "‚ùå MQTT Error<br>" + err.message;
    });

    client.on("reconnect", () => {
      infoBox.innerHTML = "üîÑ Reconnecting MQTT...";
    });

    // ======================================
    // UPDATE POSISI DARI DATA MQTT
    // ======================================
    client.on("message", (topic, message) => {
      const payload = message.toString().trim();
      console.log("üì© Data diterima:", payload);

      // Format payload: https://maps.google.com/?q=-7.62551,111.52790
      const match = payload.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
      if (!match) {
        console.warn("‚ö† Payload tidak sesuai format:", payload);
        return;
      }

      const lat = parseFloat(match[1]);
      const lon = parseFloat(match[2]);

      // Update posisi marker dan peta
      marker.setLatLng([lat, lon]);
      map.setView([lat, lon], 17, { animate: true });

      infoBox.innerHTML = `
        üì° <b>Live GPS</b><br>
        Lat: <b>${lat.toFixed(6)}</b><br>
        Lon: <b>${lon.toFixed(6)}</b><br>
        Time: ${new Date().toLocaleTimeString()}
      `;
    });
  </script>
</body>
</html>
